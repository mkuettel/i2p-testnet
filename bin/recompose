#!/usr/bin/env bash

set -eu -o pipefail

script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

getconf() {
    local attr="$1"
    jq ".$attr" < "$script_dir/../config.json"
}


NETWORK_NAME="$(getconf network.name)"

if docker network list | grep -F "$NETWORK_NAME"; then
    echo "Removing network $NETWORK_NAME as it already exists."
    docker network rm "$NETWORK_NAME"
fi

export NETWORK_NAME
docker-compose -f docker/i2p-testnet.yml up \
    --build \
    --remove-orphans \
    --force-recreate \
    --scale i2pd="$(getconf 'nodes.amount')"
