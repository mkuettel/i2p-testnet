#!/usr/bin/env bash

set -eu -o pipefail

base_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

getconf() {
    local attr="$1"
    jq ".$attr" < "$base_dir/config.json" || (
        echo "ERROR: could not read configuration file" 1>&2
        exit 4
    )
}


NETWORK_NAME="$(getconf network.name)"

if docker network list | grep -F "$NETWORK_NAME"; then
    echo "Removing network $NETWORK_NAME as it already exists."
    docker network rm "$NETWORK_NAME"
fi

OVERRIDES=()

if [[ "$(getconf network.private)" != "true" ]]; then
    OVERRIDES+=("-f" "$base_dir/docker/publicnet.override.yml")
else
    OVERRIDES+=("-f" "$base_dir/docker/privatenet.override.yml")
fi

export NETWORK_NAME
docker-compose -f "$base_dir"/docker/i2p-testnet.yml \
    "${OVERRIDES[@]}" \
    up --build \
    --remove-orphans \
    --force-recreate \
    --scale i2pd="$(getconf 'nodes.amount')"
